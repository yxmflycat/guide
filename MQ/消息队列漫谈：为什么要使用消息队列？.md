# 为什么要使用消息队列
作者：阿茂

### 思考
前面几篇文章我们说了一下在现行的互联网行业中的一个重要的组件：缓存。缓存的引入解决了我们对大量读访问的快速响应与对后端数据服务压力的降低，将高效设备（内存）的功能发挥的淋漓尽致，当然不是引入了缓存就解决了系统所有的问题。我们在这里总结下，在某些情况下，数据的变更速度小于读取速度的比率约小那么我们的缓存效率就越高，当数据的变更速度接近或者大于读取速度的时候，缓存效果就不是很明显了，所以我们在一般缓存监控中有个重要的指标就是[命中率]。那么什么情况下缓存的命中率会比较低呢？其实很容易想到，就是每一次请求最终都会改变数据结果的场景，其实就是写请求。每一个写请求至少都会改变部分数据的版本。举个例子：假设我们数据每次变更都会记录一个版本的话，第一次由100变成90，第二次由90再变成100，虽然他们两次在巧合情况下最终的变更值是一样的，但是版本值肯定是不一样的，如果中间再穿插一些其他的过程，如果不及时更新缓存的话可能就会导致部分数据错乱与最终请求失败的结果，更严重的就是程序没有严格校验将错误数据更新到数据库。说了这么多那么最终怎么解决写请求大的系统呢？哈哈，看我标题大致都知道吧。其实我们在使用各种中间件的过程中要多总结，使用它们的最终解决了什么问题，不使用它行不行？使用它给我们系统带来了多大的提示与造成了多大的复杂性与难度。
>在这里我们先抛砖引玉的擅自总结下：Redis与消息队列这两个风马牛不相及的中间件，他们相比较的话一个解决的是读的问题，一个解决的是写的问题，当然消息队列功能不止于此。

### 消息队列的演变
上面我们说到，当大量写请求，或者具体的说应该是瞬时大量的写请求到来时，既要保证系统的可用性还要保证尽量全部处理掉请求的情况下，我们在不引入消息队列的请求下，我们应该怎么处理呢？无非就是引入以下几种方式：

- 线程池：是用池化技术也在我们日常开发中缓解系统压力的一个重要利器，但是对于线程池而言很难根据系统的瞬时流量来自动伸缩容量，而且自动伸缩流量并不是根治大流量到来办法。当池子满了以后也会影响部分情况的丢弃，最重要的是一旦服务宕机，那么所有的请求将化为乌有，除非你将线程池序列化，自己想想复杂度跟性能吧。
- 队列/缓存：队列一般场景下都是使用空间来换时间的另一种常用办法，但是它的弊病也存在需要自己开发一套序列化方案，保证服务异常恢复能正常处理后续任务。Redis的发布订阅者同样存在这些问题。

上面列举了种种问题后消息队列这款中间件就呼之欲出了，它除了解决我们上面所说的问题以外还能给我们带来跟多惊喜。在开发团队资源有限的情况下直接拿来开箱即用不比你自己实现上述功能好吗？
### 使用消息队能能解决哪些问题
引入消息队列看看能帮助我们在大流量的环境下对系统有哪些改造与变化：
 - 异步化：我们举个常见的电商下单例子：在没有异步化的步骤大致是用户提交订单->预扣库存->生成订单->消费成功消息推送->通知仓库发货->数据计入财务几个串行化步骤；在串行的模式下对于整条业务链路等待时间较长，而且浪费了接口的并发带来的性能提高。如果我们从[生成订单]后就直接返回主流程，使用消息中间件后续同时处理剩余流程。既不影响整个业务的体验，而且从性能跟响应速度上有了大幅提升。
 - 缓解大流量的冲击：我们在提高了系统的并行速度后还得注意一件最重要的问题就是防止系统被大流量压垮。前面我们说到使用池化技术来削峰，引入消息中间件后就能使系统平稳的处理大流量，当然这里的处理技术没有这么简单，同样需要考虑例如消息堆积与消息丢弃等问题
 - 服务解耦：还是拿我上面说到的下单流程，随着业务逐渐发展，应用也变得复杂起来，原来一个下单流程可能就负责在一个人手里，现在可能分别在不同的人或者团队中。那么还是使用直接相互调用的话，每个子系统在开发升级的过程中为要为了上下游系统而做出妥协与让步，或者牵扯到一条业务线的多处改动适应某一个子系统的变动，每一次上线要拉着一大帮人上线，测试整条链路，这样导致系统到最后简直忍不惨睹。在引入消息队列后通过消息队列的各种特性可以让变化透明化，不在影响上下游系统，实现了系统间的解耦。
 
 以上就是我们选择使用消息队列能帮我们解决的问题，当然消息队列还有其他的功能：作为发布 / 订阅系统实现一个微服务级系统间的观察者模式；连接流计算任务和数据；用于将消息广播给大量接收者；其实在提升一个高度来说：在单应用模式下使用队列的场景，在分布式集群环境下大多都能使用消息队列来解决，当然使用消息队列给我我们带来这么多好处的同时也要做好它带来的常见性问题：消息延迟问题；系统复杂度；数据不一致；诸如这些问题。后面几节我们将展开详细说明。
 
 ### 主流的消息队列产品
 在上一节我们了解了消息队列的一些特性后面随之而来的就是，我们如何选用市面上这些消息队列产品呢，当然有自研消息队列的团队另当别论。在主流的消息队列产品中各有各的特色，对于一个公司来说没有最好的消息队列产品，只有现阶段最适合的，不要盲目更风。下面我们来介绍下市面上一些出镜率较高的消息队列：
 
 - RabbitMQ：

