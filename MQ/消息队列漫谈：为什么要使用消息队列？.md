# 为什么要使用消息队列
作者：阿茂

### 思考
前面几篇文章我们说了一下在现行的互联网行业中的一个重要的组件：缓存。缓存的引入解决了我们对大量读访问的快速响应与对后端数据服务压力的降低，将高效设备（内存）的功能发挥的淋漓尽致，当然不是引入了缓存就解决了系统所有的问题。我们在这里总结下，在某些情况下，数据的变更速度小于读取速度的比率约小那么我们的缓存效率就越高，当数据的变更速度接近或者大于读取速度的时候，缓存效果就不是很明显了，所以我们在一般缓存监控中有个重要的指标就是[命中率]。那么什么情况下缓存的命中率会比较低呢？其实很容易想到，就是每一次请求最终都会改变数据结果的场景，其实就是写请求。每一个写请求至少都会改变部分数据的版本。举个例子：假设我们数据每次变更都会记录一个版本的话，第一次由100变成90，第二次由90再变成100，虽然他们两次在巧合情况下最终的变更值是一样的，但是版本值肯定是不一样的，如果中间再穿插一些其他的过程，如果不及时更新缓存的话可能就会导致部分数据错乱与最终请求失败的结果，更严重的就是程序没有严格校验将错误数据更新到数据库。说了这么多那么最终怎么解决写请求大的系统呢？哈哈，看我标题大致都知道吧。其实我们在使用各种中间件的过程中要多总结，使用它们的最终解决了什么问题，不使用它行不行？使用它给我们系统带来了多大的提示与造成了多大的复杂性与难度。
>在这里我们先抛砖引玉的擅自总结下：Redis与消息队列这两个风马牛不相及的中间件，他们相比较的话一个解决的是读的问题，一个解决的是写的问题，当然消息队列功能不止于此。

### 消息队列的演变
上面我们说到，当大量写请求，或者具体的说应该是瞬时大量的写请求到来时，既要保证系统的可用性还要保证尽量全部处理掉请求的情况下，我们在不引入消息队列的请求下，我们应该怎么处理呢？无非就是引入以下几种方式：

- 线程池：是用池化技术也在我们日常开发中缓解系统压力的一个重要利器，但是对于线程池而言很难根据系统的瞬时流量来自动伸缩容量，而且自动伸缩流量并不是根治大流量到来办法。当池子满了以后也会影响部分情况的丢弃，最重要的是一旦服务宕机，那么所有的请求将化为乌有，除非你将线程池序列化，自己想想复杂度跟性能吧。
- 队列/缓存：队列一般场景下都是使用空间来换时间的另一种常用办法，但是它的弊病也存在需要自己开发一套序列化方案，保证服务异常恢复能正常处理后续任务。Redis的发布订阅者同样存在这些问题。

上面列举了种种问题后消息队列这款中间件就呼之欲出了，它除了解决我们上面所说的问题以外还能给我们带来跟多惊喜。在开发团队资源有限的情况下直接拿来开箱即用不比你自己实现上述功能好吗？
### 使用消息队能能解决哪些问题
引入消息队列看看能帮助我们在大流量的环境下对系统有哪些改造与变化：
 - 异步化：我们举个常见的电商下单例子：在没有异步化的步骤大致是用户提交订单->预扣库存->生成订单->消费成功消息推送->通知仓库发货->数据计入财务几个串行化步骤；在串行的模式下对于整条业务链路等待时间较长，而且浪费了接口的并发带来的性能提高。如果我们从[生成订单]后就直接返回主流程，使用消息中间件后续同时处理剩余流程。既不影响整个业务的体验，而且从性能跟响应速度上有了大幅提升。
 - 缓解大流量的冲击：我们在提高了系统的并行速度后还得注意一件最重要的问题就是防止系统被大流量压垮。前面我们说到使用池化技术来削峰，引入消息中间件后就能使系统平稳的处理大流量，当然这里的处理技术没有这么简单，同样需要考虑例如消息堆积与消息丢弃等问题
 - 服务解耦：还是拿我上面说到的下单流程，随着业务逐渐发展，应用也变得复杂起来，原来一个下单流程可能就负责在一个人手里，现在可能分别在不同的人或者团队中。那么还是使用直接相互调用的话，每个子系统在开发升级的过程中为要为了上下游系统而做出妥协与让步，或者牵扯到一条业务线的多处改动适应某一个子系统的变动，每一次上线要拉着一大帮人上线，测试整条链路，这样导致系统到最后简直忍不惨睹。在引入消息队列后通过消息队列的各种特性可以让变化透明化，不在影响上下游系统，实现了系统间的解耦。
 
 以上就是我们选择使用消息队列能帮我们解决的问题，当然消息队列还有其他的功能：作为发布 / 订阅系统实现一个微服务级系统间的观察者模式；连接流计算任务和数据；用于将消息广播给大量接收者。我们不难归纳出这样一个结果：在单应用模式下使用队列的场景，在分布式集群环境下大多都能使用消息队列来解决，当然使用消息队列给我我们带来这么多好处的同时也要做好它带来的常见性问题：消息延迟问题；系统复杂度；数据不一致；诸如这些问题。后面几节我们将展开详细说明。
 
 ### 主流的消息队列产品
 在上面我们了解了消息队列的一些特性后面随之而来的就是，我们如何选用市面上这些消息队列产品呢，当然有自研消息队列的团队另当别论。在主流的消息队列产品中各有各的特色，对于一个公司来说没有最好的消息队列产品，只有现阶段最适合的，不要盲目更风，要搞清楚我们使用消息队列的什么特性解决了我们什么问题，盲目的引入只会徒增烦恼。下面我们来介绍下市面上一些出镜率较高的消息队列以便大家选择做参考：
 
 - RabbitMQ：它是业内流行的消息队列中比较轻量级，易使用的一款使用Erlang语言实现的开源消息中间件，它的官方文档重要介绍的就是：轻量级、迅捷，它的口号就是：Messaging that just works。它支持非常灵活的路由配置，区别于其他消息中间件的设计方式就是在生产者（Producer）和队列（Queue）之间增加了一个 Exchange 模块，你可以把Exchange模块理解成一个路由交换模块，负责将生产者产生的消息根据不同的路由规则分发给不同的队列，因为它的路由规则十分灵活，而且对于自己添加自定义路由也很容易，所有你要是有这方面的需求是个不错的选择哦。而且它的客户端支持的语言支持相当丰富，哪怕是一些小语言都没有问题，关于它的原理性的东西我会在其他的篇章里面单独来说。对于流量不大与10万QPS的而且研发力量不是很充足的团队使用是非常方便的，易维护易使用，速度不比其他的慢。那么为什么说他不能用于使用大流量的场景呢 ？它官方的测试数据说根据机器的配置，它每秒钟最大能够支持几万到十几万条消息，从这个数据我们就能知道，因为它的设计理念中并没有处理消息堆积的组件或者方法，那么所有的消息都会直接进入队列中，当消费端处理不及时就会把消息堆积在队列中，直到把队列装满，这样就会导致它性能急剧下降。所以不管在使用任何消息队列的时候，消息堆积就是我们一个重要的监控指标。有时候并不是消息队列出了问题，而是消费端消费慢导致的消息堆积，发现监控异常要及时处理否则，准备更新简历吧。所以运维工作还是很重要的。它还有个不算问题的问题，那就是它本身的开发语言，二次开发和扩展功能是非常困难的，不过话说回来对于技术团队比较薄弱的团队，对于这点基本上也没啥想法，要是实在在使用过程中被你撞大运碰到bug，那么你要么去开源地址的issues贴出你的问题，要么你就使用别的迂回方式实现绕过此坑。它仅支持冗余方式的集群，无法支持分布式集群，因为它的定位就不是这个。
 
- RocketMQ：它是我们一款国产的，由阿里巴巴在2012年开源的一款由Java开发的优秀开源消息中间件。国内有很多公司在线上使用，性能可靠，中文文档也是比较齐全的。他在设计上借鉴了kafka，它有个比较大优势就在不增加机器的情况下大量增加topic性能下降不是很明显。而且它自带一套不错的后台管理系统用于设置监控消息队列。他是基于Java开发的所以基本只要有Java开发的人员就能读懂它的源码，易于扩展二次开发，基于是国产的原因，在国外的流行度并不是很高，它的周边生态就没有那么友好了。剩余组件功能就在其他消息队列中间件中就显得没有那么突出了。

- Kafka ：它最早是由LinkedIn使用Java和Scala开发的一款开源消息中间件，在1.0以后的版本基本已经发展成为了一款成熟的消息中间件了。它的周边生态支持都非常好，而且在大数据方面基本是不可代替的产品，绝大多数大数据产品都会有它的支持。它设计之初就是为了解决大数据而生的，所以采用了大量的批量跟异步的设计理念，在异步收发消息处理消息中性能比上面两款都要好，每秒钟能处理几十万条。正因为它大量采用了批量跟异步的理念，当你的消息数量不到一定数量的时候反而会出现消息延迟，除非你对参数进行调整。这个不难想象，当数量不到的时候它是不会触发批量操作的，所以就会造成消息延迟，基本上它是不太适合在线业务使用。

- 其他
在这里我就不一一介绍了，像老牌的都不怎么更新的ActiveMQ ，还有基于消息队列的多线程网络库ZeroMQ ，Yahoo 的Pulsar等等，有兴趣的自己可以去搜索相关资料看一看它们的设计理念，因为现阶段使用它们公司真的太少了。

以上就是我大致总结了现阶段大家都在玩的主流消息队列，以及它们的一些利弊，可供大家参考。也给大家提供了一些面试消息队列的区别这样的话题提供一些素材。

### 总结
这一篇我们大致说了一下为什么要使用消息队列，选用什么消息队列产品，使用它的什么特性。我们主要介绍了适用不同场景的三款主流产品：如果消息队列并不是你将要构建系统的主角之一，你对消息队列功能和性能都没有很高的要求，只需要一个开箱即用易于维护的产品，我建议你使用 RabbitMQ；如果你的系统使用消息队列主要场景是处理在线业务，比如在交易系统中用消息队列传递订单，那 RocketMQ 的低延迟和金融级的稳定性是你需要的；如果你需要处理海量的消息，像收集日志、监控信息或是前端的埋点这类数据，或是你的应用场景大量使用了大数据、流计算相关的开源产品，那 Kafka 是最适合你的消息队列。如果我说的这些场景和你的场景都不符合，你看了我之前介绍的这些消息队列的特点后，还是不知道如何选择，那就选你最熟悉的吧，毕竟这些产品都能满足大多数应用场景，使用熟悉的产品还可以快速上手不是？
