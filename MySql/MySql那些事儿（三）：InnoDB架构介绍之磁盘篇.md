#MySql那些事儿（三）：InnoDB架构介绍之磁盘篇
作者：阿茂

上一篇我们聊了InnoDB内存结构，这一篇我们聊一聊数据在磁盘上的结构。纯聊理论确实比较枯燥，感觉也没啥营养，我在这里只是想方便大家对MySQL的整体结构有个
详细的了解，在后面的文章中我会频繁的提到这些内容，先整体的过一遍有个印象。下面我就开始说InnoDb的数据磁盘结构（本篇文章不做特殊说明都是按照Mysq 5.7来讲解的）。
表大家都不陌生吧，整天CRUD的数据都在这里，也是一个系统的业务价值所在，建议大家带着对数据的敬畏之心去写代码。
在MySQL中每建一张表都会生成一个.frm文件，该文件是用来保存每个表的元数据信息的，主要包含表结构定义。
在InnoDB给我们的表提供两种表空间存储方式，默认为共享表空间，存储的文件即为后缀ibdata1共享表空间，还有一种就是独占表空间：一张表单独一个表空间（.ibd），它的存储逻辑分为
表空间（Tablespace）、段 (Segment)、区 (Extent)、页 （Page） 以及行 (row)。

![](../resource/InnoDB%20逻辑存储结构.jpg)
### 行，页，区，段，表空间
- 页：每个表空间由数据库页组成 。MySQL实例中的每个表空间都具有相同的页大小，默认页大小16K。可以使用innodb_page_size在创建MySQL实例的时候设置页大小。
- 区：默认一个区由64个连续的16KB页组成大小为1MB。
- 段：默认情况下InnoDB将一个区的前32页一次分配给它，随着段在数据库内增长时，会将整个区分配给这个段。一次最多向段中添加4个区，以保障数据的良好顺序。
一个索引分配两个段，分别存贮叶子节点和非叶子节点，这样可以保证叶子节点在磁盘上的连续性。
- 行：表的行格式决定了其行的物理存储方式，进而会影响查询和DML操作的性能。如果大量的行适合单个磁盘页，查询和索引查找可以更快地工作，缓冲池中需要的缓存内存更少，
以及写出更新值所需的IO更少。每个表中的数据分为几页。构成每个表的页以称为B树索引的树数据结构排列。表数据和二级索引都使用这种类型的结构。表示整个表的B树索引称为聚簇索引，
该聚簇索引是根据主键列进行组织的。聚集索引数据结构的节点包含该行中所有列的值。次要索引结构的节点包含索引列和主键列的值。（可变列例外，它长度超过上限后被分配在单独的磁盘页）


通过参数 innodb_file_per_table 为 1，将存储的数据、索引等信息单独存储在后缀为idb的表空间文件。建议大家采用这种方式方式存储，
因为这样存储表磁盘碎片文件少， 当表被截断的该空间马上返回给操作系统，就不会出现删除数据，磁盘占用却纹丝不动的现象。
下面我就根据表和索引的数据组成部分大致剖析下

表数据一半存在于：
- 系统表空间：使用innodb_data_file_path配置数据文件形成的表空间，这些文件在逻辑上是连续的，InnoDB会从第一个数据文件开始分配空间，你无法手动指定。
- 用户表空间：使用innodb_file_per_table配置将用户数据文件与系统数据文件分开管理，它将为每个表单独创建一个后缀为.ibd的表空间文件，
因为这样存储表磁盘碎片文件少， 当表被截断的该空间马上返回给操作系统，就不会出现删除数据，磁盘占用却纹丝不动。
- 共享表空间：它们可以在MySQL数据目录之外创建，能够容纳多个表，并支持所有行格式的表。

每个表空间由数据库页面为单位组成。MySQL实例中每个表空间都具有相同的页大小，默认为16K，可以使innodb_page_size参数自定义大小。以16K页面为例
它有1MB的扩展区（64个连续的16KB页面，128个8KB页面或256个4KB页面），32K页面->扩展区2MB以此类推。在InnoDB文件表空间内被称之为“段”（
此段与回滚段不同， 回滚段包含许多表空间段）。当段在表空间增长时，InnoDB将前32页一次分配给它，直到将整个扩展区分配给该段。
一次最多可以向一个大段中添加4个扩展区。每个索引分配了两个段：一个用于 B树的非叶节点，另一个用于叶节点。



    